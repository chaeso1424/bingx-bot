<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <title>BingX DCA Bot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/static/main.css"/>
</head>
<body>
  <div class="wrap">
    <h1>BingX DCA Bot</h1>

    <div class="grid">
      <!-- ì„¤ì • -->
      <section class="card">
        <h2>ì„¤ì •</h2>

        <div class="row">
          <label>ì‹¬ë³¼</label>
          <select id="symbol"></select>
        </div>

        <div class="row">
          <label>ì§„ì… ë°©í–¥</label>
          <select id="side">
            <option value="BUY">BUY (ë¡±)</option>
            <option value="SELL">SELL (ìˆ)</option>
          </select>
        </div>

        <div class="row">
          <label>ë§ˆì§„ ëª¨ë“œ</label>
          <select id="margin_mode">
            <option value="CROSS">CROSS</option>
            <option value="ISOLATED">ISOLATED</option>
          </select>
        </div>

        <div class="row">
          <label>ë ˆë²„ë¦¬ì§€</label>
          <input id="leverage" type="number" min="1" max="125" value="10"/>
        </div>

        <div class="row">
          <label>TP(ìµì ˆ %)</label>
          <input id="tp_percent" type="number" step="0.1" value="4.5"/>
        </div>

        <h3>DCA (ìµœëŒ€ 20ì°¨)</h3>
        <p class="hint">
          <b>#1</b>ì€ <span style="color:lightgreen">ì‹œì¥ê°€</span>ë¡œ ì§„ì…í•˜ë©° <b>ê¸ˆì•¡(USDT)</b>ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.<br/>
          <b>#2</b>ë¶€í„°ëŠ” <b>ëˆ„ì  ê°„ê²©(%)</b> ê¸°ì¤€ìœ¼ë¡œ ì§€ì •ê°€ ë¦¬ë°‹ ì£¼ë¬¸ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤.
        </p>

        <div id="dca-list"></div>

        <div class="row">
          <button id="add-dca">+ ì°¨ìˆ˜ ì¶”ê°€</button>
          <button id="pop-dca">- ë§ˆì§€ë§‰ ì‚­ì œ</button>
        </div>

        <div class="row">
          <button id="save">ğŸ’¾ ì €ì¥</button>
        </div>

        <small>ê°€ìš© USDT: <span id="avail">{{ '%0.2f' % available_usdt }}</span></small>
      </section>

      <!-- ì œì–´/ìƒíƒœ -->
      <section class="card">
        <h2>ë´‡ ì œì–´</h2>
        <div id="controls">
          <!-- ì²˜ìŒì—” ë¬´ì¡°ê±´ START ë³´ì´ê²Œ â†’ í´ë§ ì„±ê³µ í›„ í† ê¸€ -->
          <button id="start">ğŸš€ ì‹œì‘</button>
          <button id="stop" style="display:none">â¹ï¸ ì •ì§€</button>
          <button id="repeat">{{ 'ğŸ” ë°˜ë³µ ì¤‘ì§€' if repeat_mode else 'ğŸ” ë°˜ë³µ ì‹œì‘' }}</button>
        </div>

        <div class="status">
          <div>ì‹¤í–‰: <span id="st-running">{{ 'ON' if running else 'OFF' }}</span></div>
          <div>ë°˜ë³µ: <span id="st-repeat">{{ 'ON' if repeat_mode else 'OFF' }}</span></div>
          <div>í˜„ì¬ ì‹¬ë³¼: <span id="st-symbol">-</span></div>
          <div>í‰ë‹¨: <span id="st-avg">0</span></div>
          <div>ìˆ˜ëŸ‰: <span id="st-qty">0</span></div>
          <div>ë§ˆí¬ê°€: <span id="st-mark">-</span></div>
          <div>ë ˆë²„ë¦¬ì§€(ê±°ë˜ì†Œ): <span id="st-lev-exch">-</span></div>
          <div>ë ˆë²„ë¦¬ì§€(ì„¤ì •): <span id="st-lev-cfg">-</span></div>
          <div>í•„ìš” ì¦ê±°ê¸ˆ: <span id="st-budget-need">-</span></div>
          <div>ê°€ìš© ì¦ê±°ê¸ˆ: <span id="st-budget-av">-</span></div>
          <div>TP id: <span id="st-tp">-</span></div>
          <div style="color:#f66" id="st-warn"></div>
        </div>
      </section>
    </div>
  </div>

  <script type="module">
    const maxDca = 20;

    // ì…ë ¥ ì—˜ë¦¬ë¨¼íŠ¸
    const dcaList = document.getElementById('dca-list');
    const elSymbol = document.getElementById('symbol');
    const elSide   = document.getElementById('side');
    const elMode   = document.getElementById('margin_mode');
    const elLev    = document.getElementById('leverage');
    const elTp     = document.getElementById('tp_percent');

    // ìƒíƒœ ì—˜ë¦¬ë¨¼íŠ¸
    const stRun   = document.getElementById('st-running');
    const stRepeat= document.getElementById('st-repeat');
    const stSym   = document.getElementById('st-symbol');
    const stAvg   = document.getElementById('st-avg');
    const stQty   = document.getElementById('st-qty');
    const stMark  = document.getElementById('st-mark');
    const stLevX  = document.getElementById('st-lev-exch');
    const stLevCfg= document.getElementById('st-lev-cfg');
    const stNeed  = document.getElementById('st-budget-need');
    const stAv    = document.getElementById('st-budget-av');
    const stTp    = document.getElementById('st-tp');
    const stWarn  = document.getElementById('st-warn');

    // ì œì–´ ë²„íŠ¼
    const btnStart = document.getElementById('start');
    const btnStop  = document.getElementById('stop');
    const btnRepeat= document.getElementById('repeat');

    // ì„œë²„ cfg ì£¼ì…
    let cfg = {{ cfg|tojson }};

    // DCA ìƒíƒœ(ë‹¨ì¼ ì†ŒìŠ¤)
    let dcaState = Array.isArray(cfg.dca_config) && cfg.dca_config.length
      ? JSON.parse(JSON.stringify(cfg.dca_config))
      : [[0,0]];

    // ë²„íŠ¼ í‘œì‹œ í† ê¸€
    function syncControls(running) {
      if (!btnStart || !btnStop) return;
      btnStart.style.display = running ? 'none' : '';
      btnStop .style.display = running ? '' : 'none';
      if (stRun) stRun.textContent = running ? 'ON' : 'OFF';
    }

    // DCA ë Œë”/ë³€ê²½
    function rowTemplate(i, gap=0, usdt=0) {
      return `
        <div class="dca-row" data-index="${i}">
          <span class="idx">${i+1}ì°¨</span>
          <label>ê°„ê²©(%) <input type="number" step="0.1" name="gap" value="${gap}"></label>
          <label>USDT <input type="number" step="0.01" name="usdt" value="${usdt}"></label>
        </div>`;
    }
    function renderDcaList() {
      dcaList.innerHTML = '';
      dcaState.slice(0, maxDca).forEach(([gap, usdt], i) => {
        dcaList.insertAdjacentHTML('beforeend', rowTemplate(i, gap, usdt));
      });
    }
    dcaList.addEventListener('input', (e) => {
      const t = e.target;
      if (!t.matches('input[name="gap"], input[name="usdt"]')) return;
      const row = t.closest('.dca-row');
      const i = Number(row?.dataset.index ?? -1);
      if (i < 0) return;
      const gap = parseFloat(row.querySelector('input[name="gap"]').value || '0');
      const usdt = parseFloat(row.querySelector('input[name="usdt"]').value || '0');
      dcaState[i] = [gap, usdt];
    });
    document.getElementById('add-dca').addEventListener('click', () => {
      if (dcaState.length >= maxDca) return;
      dcaState.push([0,0]);
      renderDcaList();
    });
    document.getElementById('pop-dca').addEventListener('click', () => {
      if (dcaState.length <= 1) return;
      dcaState.pop();
      renderDcaList();
    });

    // ì‹¬ë³¼ ëª©ë¡
    async function loadSymbols() {
      const res = await fetch('/symbols?ts=' + Date.now(), { cache: 'no-store' });
      const list = await res.json();
      elSymbol.innerHTML = '';
      (Array.isArray(list) ? list : []).forEach(s => {
        const opt = document.createElement('option');
        opt.value = s; opt.textContent = s;
        if (s === cfg.symbol) opt.selected = true;
        elSymbol.appendChild(opt);
      });
    }

    // ì €ì¥
    async function saveConfig() {
      const payload = {
        symbol: elSymbol.value,
        side: elSide.value,
        margin_mode: elMode.value,
        leverage: parseInt(elLev.value, 10),
        tp_percent: parseFloat(elTp.value),
        dca_config: dcaState
      };
      const r = await fetch('/config?ts=' + Date.now(), {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await r.json();
      if (!r.ok) {
        alert('ì„¤ì • ì €ì¥ ì‹¤íŒ¨: HTTP ' + r.status);
        return;
      }
      if (data.error) {
        alert('ê²½ê³ : ' + data.error);
      }
      if (data.cfg) {
        cfg = data.cfg;
        dcaState = JSON.parse(JSON.stringify(cfg.dca_config || [[0,0]]));
        renderDcaList();
        elSide.value = cfg.side;
        elMode.value = cfg.margin_mode;
        elLev.value  = cfg.leverage;
        elTp.value   = cfg.tp_percent;
        [...elSymbol.options].forEach(o => o.selected = (o.value === cfg.symbol));
      }
      alert('ì„¤ì • ì €ì¥ ì™„ë£Œ');
    }
    document.getElementById('save').addEventListener('click', saveConfig);

    // ì‹œì‘/ì •ì§€/ë°˜ë³µ
    if (btnStart) btnStart.addEventListener('click', async () => {
      btnStart.disabled = true;
      try {
        const r = await fetch('/start?ts=' + Date.now(), { method: 'POST' });
        const j = await r.json();
        if (!r.ok || j.ok === false) throw new Error(j.msg || 'start failed');
      } catch (e) {
        alert('ì‹œì‘ ì‹¤íŒ¨: ' + e.message);
      } finally {
        btnStart.disabled = false;
        pollStatus();
      }
    });
    if (btnStop) btnStop.addEventListener('click', async () => {
      btnStop.disabled = true;
      try {
        const r = await fetch('/stop?ts=' + Date.now(), { method: 'POST' });
        const j = await r.json();
        if (!r.ok || j.ok === false) throw new Error(j.msg || 'stop failed');
      } catch (e) {
        alert('ì •ì§€ ì‹¤íŒ¨: ' + e.message);
      } finally {
        btnStop.disabled = false;
        pollStatus();
      }
    });
    if (btnRepeat) btnRepeat.addEventListener('click', async () => {
      btnRepeat.disabled = true;
      try {
        const r = await fetch('/repeat?ts=' + Date.now(), { method: 'POST' });
        const j = await r.json();
        if (!r.ok || j.ok === false) throw new Error(j.error || 'repeat toggle failed');
        stRepeat.textContent = j.repeat ? 'ON' : 'OFF';
        btnRepeat.textContent = j.repeat ? 'ğŸ” ë°˜ë³µ ì¤‘ì§€' : 'ğŸ” ë°˜ë³µ ì‹œì‘';
      } catch (e) {
        alert('ë°˜ë³µ í† ê¸€ ì‹¤íŒ¨: ' + e.message);
      } finally {
        btnRepeat.disabled = false;
      }
    });

    // ìƒíƒœ í´ë§
    async function pollStatus() {
      try {
        const res = await fetch('/status?ts=' + Date.now(), { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const s = await res.json();

        const pp = Number.isInteger(s.price_precision) ? s.price_precision : 4;
        const num = (v, p = pp) => (v === null || v === undefined || isNaN(+v) ? '-' : (+v).toFixed(p));

        stSym.textContent = s.symbol || '-';
        stAvg.textContent = num(s.position_avg_price);
        stQty.textContent = num(s.position_qty, 0);
        stMark.textContent = num(s.mark_price);
        stLevX.textContent = s.exchange_leverage ?? '-';
        stLevCfg.textContent = s.cfg_leverage ?? '-';
        stNeed.textContent = s.budget_required != null ? num(s.budget_required, 4) : '-';
        stAv.textContent   = s.budget_available != null ? num(s.budget_available, 4) : '-';
        stTp.textContent   = s.tp_order_id || '-';

        // ë²„íŠ¼ í‘œì‹œ ë™ê¸°í™”
        syncControls(!!s.running);

        // ë°˜ë³µ ìƒíƒœ
        const rep = !!s.repeat_mode;
        stRepeat.textContent = rep ? 'ON' : 'OFF';
        btnRepeat.textContent = rep ? 'ğŸ” ë°˜ë³µ ì¤‘ì§€' : 'ğŸ” ë°˜ë³µ ì‹œì‘';

        // ë ˆë²„ë¦¬ì§€ ë¶ˆì¼ì¹˜ ê²½ê³ 
        if (s.exchange_leverage && s.cfg_leverage &&
            Math.abs((+s.exchange_leverage) - (+s.cfg_leverage)) > 0.01) {
          stWarn.textContent = `ë ˆë²„ë¦¬ì§€ ë¶ˆì¼ì¹˜: ê±°ë˜ì†Œ ${s.exchange_leverage}x â‰  ì„¤ì • ${s.cfg_leverage}x`;
        } else {
          stWarn.textContent = '';
        }
      } catch (e) {
        // í´ë§ ì‹¤íŒ¨ ì‹œì—ë„ ê¸°ë³¸ ë²„íŠ¼(START) ë³´ì´ê²Œ ìœ ì§€
        syncControls(false);
      }
    }

    // ì´ˆê¸°í™”
    await loadSymbols();
    elSide.value = cfg.side || 'BUY';
    elMode.value = cfg.margin_mode || 'CROSS';
    elLev.value  = cfg.leverage ?? 10;
    elTp.value   = cfg.tp_percent ?? 4.5;
    renderDcaList();

    // ì²« í´ë§ ë° ì£¼ê¸° í´ë§
    await pollStatus();
    let t = setInterval(pollStatus, 1500);
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) { clearInterval(t); }
      else { pollStatus(); t = setInterval(pollStatus, 1500); }
    });
  </script>
</body>
</html>
